generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model customers {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String    @db.VarChar(120)
  phone      String?   @db.VarChar(20)
  email      String?   @db.VarChar(120)
  address    String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  sales      sales[]
}

model products {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String        @db.VarChar(120)
  sku         String        @unique @db.VarChar(64)
  group       String?       @db.VarChar(64)
  category    String?       @db.VarChar(64)
  opening_qty Int?          @default(0)
  unit        String?       @db.VarChar(16)
  is_active   Boolean?      @default(true)
  created_at  DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?     @default(now()) @db.Timestamptz(6)
  item_type   String        @default("FINISHED") @db.VarChar(20)
  purchases   purchases[]
  sales       sales[]
  stock_items stock_items[]
  invoice_items invoice_items[] @relation("invoice_items_products")

  @@index([sku], map: "idx_products_sku")
}

model purchases {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  supplier_id   String    @db.Uuid
  product_id    String    @db.Uuid
  quantity      Int
  unit_price    Decimal   @db.Decimal(12, 2)
  total         Decimal?  @db.Decimal(12, 2)
  purchase_date DateTime? @default(now()) @db.Timestamptz(6)
  products      products  @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  suppliers     suppliers @relation(fields: [supplier_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([supplier_id], map: "idx_purchases_supplier_id")
}

model roles {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String    @unique @db.VarChar(30)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users[]
}

model sales {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customer_id String    @db.Uuid
  product_id  String    @db.Uuid
  quantity    Int
  unit_price  Decimal   @db.Decimal(12, 2)
  total       Decimal?  @db.Decimal(12, 2)
  sale_date   DateTime? @default(now()) @db.Timestamptz(6)
  customers   customers @relation(fields: [customer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products    products  @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([customer_id], map: "idx_sales_customer_id")
}

model stock_items {
  id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id String              @db.Uuid
  type       stock_movement_type
  quantity   Int
  reference  String?             @db.VarChar(64)
  txn_date   DateTime            @default(now()) @db.Timestamptz(6)
  created_at DateTime?           @default(now()) @db.Timestamptz(6)
  products   products            @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([product_id], map: "idx_stock_items_product_id")
  @@index([txn_date], map: "idx_stock_items_txn_date")
}

model suppliers {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String      @db.VarChar(120)
  contact    String?     @db.VarChar(120)
  phone      String?     @db.VarChar(20)
  email      String?     @db.VarChar(120)
  address    String?
  created_at DateTime?   @default(now()) @db.Timestamptz(6)
  purchases  purchases[]
}

model invoices {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoice_number String          @unique @db.VarChar(32)
  customer_id   String           @db.Uuid
  issue_date    DateTime         @default(now()) @db.Timestamptz(6)
  due_date      DateTime         @db.Timestamptz(6)
  total_amount  Decimal          @db.Decimal(14, 2)
  paid_amount   Decimal          @default(0) @db.Decimal(14, 2)
  tax           Decimal          @default(0) @db.Decimal(14, 2)
  discount      Decimal          @default(0) @db.Decimal(14, 2)
  status        invoice_status   @default(DRAFT)
  notes         String?
  created_at    DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?        @default(now()) @db.Timestamptz(6)
  line_items    invoice_items[]

  @@index([customer_id], map: "idx_invoices_customer_id")
  @@index([invoice_number], map: "idx_invoices_invoice_number")
  @@index([status], map: "idx_invoices_status")
}

model invoice_items {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoice_id  String    @db.Uuid
  product_id  String    @db.Uuid
  quantity    Int
  unit_price  Decimal   @db.Decimal(12, 2)
  amount      Decimal   @db.Decimal(14, 2)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  invoices    invoices  @relation(fields: [invoice_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products    products  @relation("invoice_items_products", fields: [product_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([invoice_id], map: "idx_invoice_items_invoice_id")
  @@index([product_id], map: "idx_invoice_items_product_id")
}

model users {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String    @db.VarChar(120)
  email      String    @unique @db.VarChar(120)
  password   String    @db.VarChar(120)
  role_id    String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  roles      roles     @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([role_id], map: "idx_users_role_id")
}

enum stock_movement_type {
  IN
  OUT
}

enum invoice_status {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}
